/*
	MIT License http://www.opensource.org/licenses/mit-license.php
	Author Tobias Koppers @sokra
*/
"use strict";

<<<<<<< HEAD
function chunkContainsModule(chunk, module) {
	const chunks = module.chunks;
	const modules = chunk.modules;
	if(chunks.length < modules.length) {
		return chunks.indexOf(chunk) >= 0;
	} else {
		return modules.indexOf(module) >= 0;
	}
}

function hasModule(chunk, module, checkedChunks) {
	if(chunkContainsModule(chunk, module)) return [chunk];
	if(chunk.parents.length === 0) return false;
	return allHaveModule(chunk.parents.filter((c) => {
		return checkedChunks.indexOf(c) < 0;
=======
function hasModule(chunk, module, checkedChunks) {
	if(chunk.containsModule(module)) return [chunk];
	if(chunk.parents.length === 0) return false;
	return allHaveModule(chunk.parents.filter((c) => {
		return !checkedChunks.has(c);
>>>>>>> a4c8ddeeb5097388569b6792db75ab5aa2073f51
	}), module, checkedChunks);
}

function allHaveModule(someChunks, module, checkedChunks) {
<<<<<<< HEAD
	if(!checkedChunks) checkedChunks = [];
	var chunks = [];
	for(var i = 0; i < someChunks.length; i++) {
		checkedChunks.push(someChunks[i]);
=======
	if(!checkedChunks) checkedChunks = new Set();
	var chunks = new Set();
	for(var i = 0; i < someChunks.length; i++) {
		checkedChunks.add(someChunks[i]);
>>>>>>> a4c8ddeeb5097388569b6792db75ab5aa2073f51
		var subChunks = hasModule(someChunks[i], module, checkedChunks);
		if(!subChunks) return false;

		for(var index = 0; index < subChunks.length; index++) {
			var item = subChunks[index];

<<<<<<< HEAD
			if(!chunks.length || chunks.indexOf(item) < 0) {
				chunks.push(item);
			}
=======
			chunks.add(item);
>>>>>>> a4c8ddeeb5097388569b6792db75ab5aa2073f51
		}
	}
	return chunks;
}

<<<<<<< HEAD
function debugIds(chunks) {
	var list = [];
	for(var i = 0; i < chunks.length; i++) {
		var debugId = chunks[i].debugId;

		if(typeof debugId !== "number") {
			return "no";
		}

		list.push(debugId);
	}

	list.sort();
	return list.join(",");
}

=======
>>>>>>> a4c8ddeeb5097388569b6792db75ab5aa2073f51
class RemoveParentModulesPlugin {
	apply(compiler) {
		compiler.plugin("compilation", (compilation) => {
			compilation.plugin(["optimize-chunks-basic", "optimize-extracted-chunks-basic"], (chunks) => {
				for(var index = 0; index < chunks.length; index++) {
					var chunk = chunks[index];
					if(chunk.parents.length === 0) continue;

					// TODO consider Map when performance has improved https://gist.github.com/sokra/b36098368da7b8f6792fd7c85fca6311
					var cache = Object.create(null);
<<<<<<< HEAD
					var modules = chunk.modules.slice();
					for(var i = 0; i < modules.length; i++) {
						var module = modules[i];

						var dId = debugIds(module.chunks);
						var parentChunksWithModule;
						if((dId in cache) && dId !== "no") {
=======
					var modules = chunk.getModules();
					for(var i = 0; i < modules.length; i++) {
						var module = modules[i];

						var dId = module.getChunkIdsIdent();
						var parentChunksWithModule;
						if(dId === null) {
							parentChunksWithModule = allHaveModule(chunk.parents, module);
						} else if(dId in cache) {
>>>>>>> a4c8ddeeb5097388569b6792db75ab5aa2073f51
							parentChunksWithModule = cache[dId];
						} else {
							parentChunksWithModule = cache[dId] = allHaveModule(chunk.parents, module);
						}
						if(parentChunksWithModule) {
<<<<<<< HEAD
							module.rewriteChunkInReasons(chunk, parentChunksWithModule);
=======
							module.rewriteChunkInReasons(chunk, Array.from(parentChunksWithModule));
>>>>>>> a4c8ddeeb5097388569b6792db75ab5aa2073f51
							chunk.removeModule(module);
						}
					}
				}
			});
		});
	}
}
module.exports = RemoveParentModulesPlugin;
